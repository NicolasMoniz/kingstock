{% extends "base.twig" %}
{% block title %}{{ enchere.lot.getNom }} - {{ lang.Encherir }} - KingStock{% endblock %}
{% block description %} {% endblock %}
{% block keywords %} {% endblock %}
{% block body %}
    <main>
    <div class="confirm-add-to-cart" id="confirmAddToCart">
        <h3>{{ lang.congratz }}</h3>
        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
             viewBox="0 0 501.551 501.551" style="display:block; margin: auto; width: 5rem; enable-background:new 0 0 501.551 501.551;" xml:space="preserve">
<polygon style="fill:#FF7058;" points="296.751,412.735 204.8,412.735 220.473,379.298 234.057,347.951 267.494,347.951
	281.078,379.298 "/>
            <path style="fill:#FFD15C;" d="M355.265,412.735h-208.98c-11.494,0-20.898,9.404-20.898,20.898v67.918h249.731v-67.918
	C376.163,422.139,366.759,412.735,355.265,412.735z"/>
            <path style="fill:#F1543F;" d="M281.078,379.298c-8.359,4.18-16.718,8.359-25.078,11.494l-5.224,1.045l-5.225-2.09
	c-8.359-3.135-16.718-7.314-25.078-11.494l13.584-31.347h32.392L281.078,379.298z"/>
            <g>
                <path style="fill:#F8B64C;" d="M0,57.469v42.841C0,204.8,64.784,294.661,155.69,332.278c29.257,12.539,61.649,18.808,95.086,18.808
		s65.829-6.269,95.086-18.808c90.906-37.616,155.69-127.478,155.69-231.967V57.469H0z M459.755,100.31
		c0,50.155-17.763,96.131-48.065,132.702c-38.661,45.975-96.131,76.278-160.914,76.278s-122.253-29.257-160.914-76.278
		c-29.257-35.527-48.065-82.547-48.065-132.702v-1.045H458.71v1.045H459.755z"/>
                <path style="fill:#F8B64C;" d="M413.78,0H87.771c-7.314,0-12.539,6.269-12.539,12.539c0,7.314,5.224,13.584,12.539,13.584H413.78
		c7.314,0,12.539-6.269,12.539-12.539C426.318,6.269,421.094,0,413.78,0z"/>
            </g>
            <path style="fill:#FFD15C;" d="M413.78,26.122v112.849c0,104.49-64.784,199.576-163.004,237.192
	c-98.22-38.661-163.004-132.702-163.004-238.237V26.122H413.78z"/>
            <polygon style="fill:#FFFFFF;" points="250.776,73.143 272.718,140.016 342.727,140.016 286.302,181.812 307.2,248.686
	250.776,206.89 194.351,248.686 215.249,181.812 158.824,140.016 228.833,140.016 "/>
            <rect x="87.771" y="26.122" style="fill:#FFC952;" width="324.963" height="15.673"/>
</svg>
        <p>{{ lang.won_bid }}</p>
        <p>{{ lang.check_account }}</p>
        <a href="account/index">
            <div class="button button-jungle">{{ lang.Moncompte }}</div>
        </a>
    </div>

    <div class="fail-add-to-cart" id="failAddToCart">
        <h3>{{ lang.Dommage }}...</h3>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
             viewBox="0 0 512 512" style="display:block; margin: auto; width: 5rem; enable-background:new 0 0 512 512;" xml:space="preserve">
<circle style="fill:#FFE17D;" cx="256" cy="256" r="256"/>
            <path style="fill:#7D5046;" d="M169.29,256L169.29,256c-11.402,0-20.645-9.243-20.645-20.645v-16.516
	c0-11.402,9.243-20.645,20.645-20.645l0,0c11.402,0,20.645,9.243,20.645,20.645v16.516C189.935,246.757,180.692,256,169.29,256z"/>
            <path style="fill:#9C6846;" d="M169.29,198.194c-1.414,0-2.794,0.145-4.129,0.416v28.487c0,6.841,5.546,12.387,12.387,12.387
	s12.387-5.546,12.387-12.387v-8.258C189.935,207.436,180.693,198.194,169.29,198.194z"/>
            <path style="fill:#7D5046;" d="M342.71,256L342.71,256c-11.402,0-20.645-9.243-20.645-20.645v-16.516
	c0-11.402,9.243-20.645,20.645-20.645l0,0c11.402,0,20.645,9.243,20.645,20.645v16.516C363.355,246.757,354.112,256,342.71,256z"/>
            <path style="fill:#9C6846;" d="M342.71,198.194c-1.414,0-2.794,0.145-4.129,0.416v28.487c0,6.841,5.546,12.387,12.387,12.387
	s12.387-5.546,12.387-12.387v-8.258C363.355,207.436,354.112,198.194,342.71,198.194z"/>
            <path style="fill:#AA7346;" d="M173.387,381.935c-2.5,0-5.008-0.903-6.992-2.726c-4.194-3.863-4.468-10.391-0.605-14.589
	c20.952-22.77,54.669-36.363,90.177-36.363c35.524,0,69.234,13.597,90.177,36.367c3.863,4.194,3.589,10.726-0.605,14.585
	c-4.185,3.863-10.726,3.601-14.589-0.609c-17.105-18.597-45.137-29.698-74.984-29.698c-29.839,0-57.871,11.101-74.984,29.702
	C178.952,380.815,176.169,381.935,173.387,381.935z"/>
            <path style="fill:#FFD164;" d="M293.161,474.839c-141.385,0-256-114.615-256-256c0-61.227,21.521-117.411,57.376-161.463
	C36.863,104.316,0,175.842,0,256c0,141.385,114.615,256,256,256c80.159,0,151.685-36.864,198.626-94.538
	C410.573,453.317,354.389,474.839,293.161,474.839z"/>
</svg>

        <p>{{ lang.loose_bid }}</p>
        <p></p>
        <a href="/">
            <div class="button button-jungle">{{ lang.Accueil }}</div>
        </a>
    </div>

    <section class="banner banner-home">

    </section>
    <section class="container-100 margin-bottom-20">
        <ul class="breadcrumb">
            <li><a href="/">{{ lang.Accueil }}</a></li>
            <li><a href="/enchere/now">{{ lang.Enchères }}</a></li>
            <li><a href="/enchere/desc?id={{ enchere.getId}}">{{ lang.Description }}</a></li>
            <li><a href="">{{ enchere.lot.getNom }}</a></li>
        </ul>
        <h1>{{ enchere.lot.getNom }}</h1>
        <div class="wrapper-bid">
            <div class="wrapper-last-bid">
                <div class="last-bid-header margin-bottom-5">
                    <h2>{{ lang.DERNIERES_ENCHERES_SUR_CE_LOT }}</h2>
                </div>
                <div class="bids">

                </div>

                <div class="last-bid-bottom">
                    <div class="last-bid-bottom-left"></div>
                    <div class="last-bid-bottom-right">
                        <p><i style="color: #FC6C0F" class="fas fa-info-circle"></i>
                            Les frais d’administration ne sont pas
                            inclus dans le prix affiché.
                            Si vous remportez l’enchère, vous êtes tenu de payer la mise
                            gagnante ainsi que les frais d’administration.
                        </p>
                    </div>
                </div>
            </div>
            <div class="wrapper-do-bid">
                <div class="do-bid-info">
                    <p>Temps restant pour ce lot :</p>
                    <div class="time" finish="{{ enchere.getDatefin }}">{{ enchere.getTime }}</div>
                    <p>Enchère actuelle :</p>
                    <div class="price">{{ enchere.getPrice }} €</div>
                </div>
                <div class="do-bid-start-price" style="background-color: #9c8c9d;">
                    <p>Prix de départ : {{ enchere.getPrixDepart }} €</p>
                </div>
                <div class="do-bid-do-bid-da">
                    <div class="do-bid-select-price-container">
                        <button onclick="pasencherir(false)" class="button-select-price button-minus">
                            <svg  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                 version="1.1" id="-" x="0px" y="0px" viewBox="0 0 491.858 491.858"
                                 style="enable-background:new 0 0 491.858 491.858;" xml:space="preserve" width="10px"
                                 height="10px">
	<g>
        <path d="M465.167,211.613H240.21H26.69c-8.424,0-26.69,11.439-26.69,34.316s18.267,34.316,26.69,34.316h213.52h224.959    c8.421,0,26.689-11.439,26.689-34.316S473.59,211.613,465.167,211.613z"
              fill="#FFFFFF"/>
    </g></svg>
                        </button>
                        <div class="view-price">{{ enchere.getPrice }}</div>
                        <button onclick="pasencherir(true)" class="button-select-price button-plus">
                            <svg  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                 version="1.1" id="+" x="0px" y="0px" viewBox="0 0 491.86 491.86"
                                 style="enable-background:new 0 0 491.86 491.86;" xml:space="preserve" width="10px"
                                 height="10px">
	<g>
        <path d="M465.167,211.614H280.245V26.691c0-8.424-11.439-26.69-34.316-26.69s-34.316,18.267-34.316,26.69v184.924H26.69    C18.267,211.614,0,223.053,0,245.929s18.267,34.316,26.69,34.316h184.924v184.924c0,8.422,11.438,26.69,34.316,26.69    s34.316-18.268,34.316-26.69V280.245H465.17c8.422,0,26.69-11.438,26.69-34.316S473.59,211.614,465.167,211.614z"
              fill="#FFFFFF"/>
    </g></svg>
                        </button>
                    </div>
                    <div class="do-bid-go-bid-container">
                        <button id="button-encherir" class="button" onclick="encherir()">enchérir</button>
                    </div>
                </div>
                <p class="info-text">Le pas de cet enchère est de {{ enchere.getPas }} €</p>
            </div>
        </div>
    </section>

    <script>
        var pas = {{ enchere.getPas }};
        function showAddToCart() {
            var data = new FormData();
            data.append('id_user', {{ session.id_user }});
            data.append('id_enchere',{{ enchere.getId }});

            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState===4 && xmlhttp.status===200)
                {
                    var e = JSON.parse(xmlhttp.responseText);
                    if(e.yesornot){
                        document.getElementById('confirmAddToCart').style.display = "block";
                    }
                    else{
                        document.getElementById('failAddToCart').style.display = "block";
                        document.querySelector("#button-encherir").setAttribute('disabled', 'disabled');
                        document.querySelector("#button-encherir").innerHTML="Perdu";
                        document.querySelector("#button-encherir").className="button light-red";
                    }
                }
            };
            xmlhttp.open("POST","{{ base_url("/Enchere/win") }}",true);
            xmlhttp.send(data);
        }

        function CountDownTimer(dt, time) {
            var end = new Date(dt);

            var _second = 1000;
            var _minute = _second * 60;
            var _hour = _minute * 60;
            var _day = _hour * 24;
            var timer;

            function showRemaining() {
                var now = new Date();
                var distance = end - now;
                if (distance < 0) {

                    clearInterval(timer);
                    time.innerHTML = '{{ lang.Fin }}';
                    showAddToCart();


                    return;
                }
                var days = Math.floor(distance / _day);
                var hours = Math.floor((distance % _day) / _hour);
                var minutes = Math.floor((distance % _hour) / _minute);
                var seconds = Math.floor((distance % _minute) / _second);
                time.innerHTML = "";
                if (days !== 0) {
                    time.innerHTML += days + 'j : ';
                }

                time.innerHTML += hours + 'h : ';
                time.innerHTML += minutes + 'm : ';
                time.innerHTML += seconds + 's';
                majenchere({{ enchere.getId }})
            }

            timer = setInterval(showRemaining, 1000);
        }

        window.onload = function () {
            majencherefirst({{ enchere.getId }})
            var arraytimer = document.querySelectorAll('.time');

            arraytimer.forEach(function (element) {
                CountDownTimer(element.getAttribute('finish'), element);
            });
        };

        function majenchere(a){
            var data = new FormData();
            data.append('id', a);

            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState===4 && xmlhttp.status===200)
                {
                    var e = JSON.parse(xmlhttp.responseText);
                    if(document.querySelector(".price").innerHTML !==e[0].prix + " €"){
                        document.querySelector(".price").innerHTML=e[0].prix + " €";
                        document.querySelector(".view-price").innerHTML=e[0].prix;
                        var bids = document.querySelector(".bids");
                        bids.innerHTML="";
                        e.forEach(function (value) {
                            var biddate=new Date(value.date).toLocaleString();
                            bids.innerHTML+="<div class=\"last-bid-core\">\n" +
                                "                        <div class=\"last-bid-core-time-line-container\">\n" +
                                "                            <p>{{ lang.Encherisseur }} "+value.user+" - "+biddate+"</p>\n" +
                                "                        </div>\n" +
                                "                        <div class=\"last-bid-core-price-container\">\n" +
                                "                            <div class=\"first-core-time-line-price\">\n" +
                                "                                <p class=\"bold\">"+value.prix+" €</p>\n" +
                                "                            </div>\n" +
                                "                        </div>\n" +
                                "                    </div>"
                        });
                        if(parseInt(e[0].user)==={{ session.id_user }}){
                            document.querySelector("#button-encherir").setAttribute('disabled', 'disabled');
                            document.querySelector("#button-encherir").innerHTML="Vous avez la main";
                            document.querySelector("#button-encherir").className+=" win";
                        }
                        else{
                            document.querySelector("#button-encherir").removeAttribute("disabled");
                            document.querySelector("#button-encherir").innerHTML="Encherir";
                            document.querySelector("#button-encherir").className="button";
                        }
                    }

                }
            };
            xmlhttp.open("POST","{{ base_url("/Enchere/encherisseurs") }}",true);
            xmlhttp.send(data);
        }

        function majencherefirst(a){
            var data = new FormData();
            data.append('id', a);

            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState===4 && xmlhttp.status===200)
                {
                    var e = JSON.parse(xmlhttp.responseText);

                    document.querySelector(".price").innerHTML=e[0].prix + " €";
                    document.querySelector(".view-price").innerHTML=e[0].prix;
                    var bids = document.querySelector(".bids");
                    bids.innerHTML="";
                    e.forEach(function (value) {
                        var biddate=new Date(value.date).toLocaleString();
                        bids.innerHTML+="<div class=\"last-bid-core\">\n" +
                            "                        <div class=\"last-bid-core-time-line-container\">\n" +
                            "                            <p>{{ lang.Encherisseur }} "+value.user+" - "+biddate+"</p>\n" +
                            "                        </div>\n" +
                            "                        <div class=\"last-bid-core-price-container\">\n" +
                            "                            <div class=\"first-core-time-line-price\">\n" +
                            "                                <p>"+value.prix+" €</p>\n" +
                            "                            </div>\n" +
                            "                        </div>\n" +
                            "                    </div>"
                    });
                    if(parseInt(e[0].user)==={{ session.id_user }}){
                        document.querySelector("#button-encherir").setAttribute('disabled', 'disabled');
                        document.querySelector("#button-encherir").innerHTML="Vous avez la main";
                        document.querySelector("#button-encherir").className+=" win";
                    }
                    else{
                        document.querySelector("#button-encherir").removeAttribute("disabled");
                        document.querySelector("#button-encherir").innerHTML="Encherir";
                        document.querySelector("#button-encherir").className="button";
                    }

                }
            };
            xmlhttp.open("POST","{{ base_url("/Enchere/encherisseurs") }}",true);
            xmlhttp.send(data);
        }

        function pasencherir(operator){
            if(operator){
                document.querySelector(".view-price").innerHTML=parseInt(document.querySelector(".view-price").innerHTML)+pas;
            }else{
                document.querySelector(".view-price").innerHTML=parseInt(document.querySelector(".view-price").innerHTML)-pas;
            }
        }
        function encherir(){
            if(parseInt(document.querySelector(".price").innerHTML)<parseInt(document.querySelector(".view-price").innerHTML)){
                var data = new FormData();
                data.append('id_user', {{ session.id_user }});
                data.append('price',document.querySelector(".view-price").innerHTML);
                data.append('id_enchere',{{ enchere.getId }});

                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange=function()
                {
                    if (xmlhttp.readyState===4 && xmlhttp.status===200)
                    {
                        var a = JSON.parse(xmlhttp.responseText);
                        if(a.yesornot===true){
                            majenchere({{ enchere.getId }})
                        }
                    }
                };
                xmlhttp.open("POST","{{ base_url("/Enchere/encherir") }}",true);
                xmlhttp.send(data);
            }
        }
    </script>
{% endblock %}